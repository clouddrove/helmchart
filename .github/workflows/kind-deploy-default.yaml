name: KIND Deploy (Default Values)

on: [push, pull_request]

permissions:
  contents: read

jobs:
  kind-deploy-default:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up KIND cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: test

      - name: Deploy charts (default values)
        run: |
          set -e

          GREEN='\033[0;32m'
          BLUE='\033[0;34m'
          YELLOW='\033[1;33m'
          NC='\033[0m'

          for chart in charts/*; do
            if [ -f "$chart/Chart.yaml" ]; then
              chart_name=$(basename "$chart")

              echo "::group::Deploy default - $chart_name"
              echo -e "${BLUE}==================================================${NC}"
              echo -e "${GREEN}ðŸš€ Deploying: ${chart_name}${NC}"
              echo -e "${BLUE}==================================================${NC}"

              echo -e "${YELLOW}â–¶ Helm deploy (--debug)${NC}"
              helm upgrade --install "$chart_name" "$chart" \
                --namespace "$chart_name" \
                --create-namespace \
                --debug 2>&1 | tee /tmp/helm-${chart_name}.log

              echo -e "${YELLOW}â–¶ Kubernetes objects (rendered by Helm)${NC}"
              helm upgrade --install "$chart_name" "$chart" \
                --namespace "$chart_name" \
                --create-namespace \
                --dry-run --debug 2>&1 | grep "^kind:" | sed 's/kind:/Kind:/'

              echo -e "${GREEN}âœ” Deployed ${chart_name}${NC}"
              echo "::endgroup::"
            fi
          done

